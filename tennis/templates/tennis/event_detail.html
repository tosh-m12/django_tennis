<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>{{ club.name }} - {{ event.date }} ç·´ç¿’ä¼š</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: sans-serif; margin: 16px; }
    .row { display:flex; gap:16px; flex-wrap:wrap; align-items:flex-start; }
    .card { border:1px solid #ddd; border-radius:12px; padding:14px; min-width:360px; }
    h1 { margin:0 0 10px; font-size:20px; }
    h2 { margin:0 0 10px; font-size:16px; }
    table { border-collapse:collapse; width:100%; }
    th, td { border:1px solid #ddd; padding:8px; text-align:center; }
    .btn { padding:6px 10px; border:1px solid #ccc; border-radius:8px; background:#f7f7f7; cursor:pointer; }
    .muted { color:#666; font-size:12px; }
    input[type="text"] { padding:6px 8px; }
    .locked { background:#fff3cd; border-color:#ffeeba; }
  </style>
</head>
<body>

<h1>ğŸ¾ {{ club.name }} / {{ event.date }} ç·´ç¿’ä¼š</h1>
<div class="muted">
  {% if event.locked_at %}
    ğŸ”’ ãƒ­ãƒƒã‚¯ä¸­ï¼ˆ{{ event.locked_at }}ï¼‰
  {% else %}
    æœªãƒ­ãƒƒã‚¯ï¼ˆã‚¹ã‚³ã‚¢å…¥åŠ›ã§ãƒ­ãƒƒã‚¯ï¼‰
  {% endif %}
</div>

<div class="row">
  <div class="card">
    <h2>å‡ºæ¬ è¡¨</h2>
    <table>
      <thead>
        <tr>
          <th>åå‰</th>
          <th>å‡ºæ¬ </th>
          <th>è©¦åˆå‚åŠ </th>
          <th>ãƒ•ãƒ©ã‚°</th>
          <th>ã‚³ãƒ¡ãƒ³ãƒˆ</th>
          <th>ä¿å­˜</th>
        </tr>
      </thead>
      <tbody>
        {% for a in attendances %}
          <tr data-pid="{{ a.participant.id }}">
            <td>{{ a.participant.display_name }}</td>
            <td>
              <select class="att-select">
                <option value="yes" {% if a.attendance == "yes" %}selected{% endif %}>ã€‡</option>
                <option value="no" {% if a.attendance == "no" %}selected{% endif %}>Ã—</option>
                <option value="maybe" {% if a.attendance == "maybe" %}selected{% endif %}>ï¼Ÿ</option>
              </select>
            </td>
            <td><input type="checkbox" class="pm-check" {% if a.participates_match %}checked{% endif %}></td>
            <td style="text-align:left">
              {% for f in flags %}
                <label style="display:inline-block;margin-right:8px;">
                  <input type="checkbox" class="flag-check" data-flag-id="{{ f.id }}"> {{ f.name }}
                </label>
              {% endfor %}
            </td>
            <td><input type="text" class="comment" value="{{ a.comment|default_if_none:'' }}" style="width:140px"></td>
            <td><button class="btn save-att">ä¿å­˜</button></td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    <div class="muted">â€» æœ€çŸ­ï¼šè¡Œå˜ä½ã§ä¿å­˜ï¼ˆã‚ã¨ã§ãƒ¢ãƒ¼ãƒ€ãƒ«åŒ–ã§ãã¾ã™ï¼‰</div>
  </div>

  <div class="card {% if event.locked_at %}locked{% endif %}">
    <h2>å¯¾æˆ¦è¡¨</h2>
    <div style="display:flex; gap:8px; margin-bottom:10px;">
      <button id="gen-btn" class="btn">ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆ</button>
            <label class="muted">rounds:
                <input id="rounds" type="text" value="2" style="width:40px;">
            </label>
      <button id="reset-btn" class="btn">ãƒªã‚»ãƒƒãƒˆï¼ˆã‚¹ã‚³ã‚¢ç ´æ£„ï¼‰</button>
    </div>

    <div id="schedule"></div>

    <div class="muted">
      ç”Ÿæˆæ¡ä»¶ï¼šå‡ºæ¬ =ã€‡ ã‹ã¤ è©¦åˆå‚åŠ =ON ã®äººã ã‘<br>
      ã‚¹ã‚³ã‚¢å…¥åŠ›ãŒ1ã¤ã§ã‚‚å…¥ã‚‹ã¨ãƒ­ãƒƒã‚¯ï¼ˆå†ç”Ÿæˆã¯ forceï¼‰
    </div>
  </div>
</div>

<script>
  const EVENT_ID = {{ event.id }};
  const CHECKED_MAP = {{ checked_map_json|safe }};
  const INITIAL_SCHEDULE = {{ schedule_json|safe }};
  const IS_LOCKED = {{ event.locked_at|yesno:"true,false" }};

  // æ—¢å­˜ãƒ•ãƒ©ã‚°ãƒã‚§ãƒƒã‚¯åæ˜ 
  document.querySelectorAll("tr[data-pid]").forEach(tr => {
    const pid = tr.dataset.pid;
    tr.querySelectorAll(".flag-check").forEach(chk => {
      const fid = chk.dataset.flagId;
      const key = tr.dataset.pid + "_" + fid;
      if (CHECKED_MAP[key]) chk.checked = true;
    });
  });

  async function postForm(url, data) {
    const fd = new URLSearchParams();
    for (const [k, v] of Object.entries(data)) fd.append(k, v);
    const res = await fetch(url, { method:"POST", body: fd });
    const ct = res.headers.get("content-type") || "";
    if (ct.includes("application/json")) return await res.json();
    const txt = await res.text();
    throw new Error(`HTTP ${res.status}: ${txt}`);
  }

  // å‡ºæ¬ è¡Œ ä¿å­˜
  document.querySelectorAll(".save-att").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      const tr = e.target.closest("tr");
      const pid = tr.dataset.pid;
      const attendance = tr.querySelector(".att-select").value;
      const pm = tr.querySelector(".pm-check").checked ? "1" : "0";
      const comment = tr.querySelector(".comment").value;

      const flags = [];
      tr.querySelectorAll(".flag-check").forEach(chk => {
        if (chk.checked) flags.push(chk.dataset.flagId);
      });

      try {
        const r = await postForm(`/api/event/${EVENT_ID}/attendance/update/`, {
          participant_id: pid,
          attendance,
          participates_match: pm,
          comment,
          flags: flags.join(","),
        });
        if (!r.ok) throw new Error(r.error || "failed");
        alert("ä¿å­˜ã—ã¾ã—ãŸ");
      } catch (err) {
        alert(err.message);
      }
    });
  });

    function esc(s){
      return (s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }

    function renderSchedule(s) {
      const root = document.getElementById("schedule");
      if (!s || s.length === 0) {
        root.innerHTML = "<div class='muted'>ã¾ã å¯¾æˆ¦è¡¨ãŒã‚ã‚Šã¾ã›ã‚“</div>";
        return;
      }

      // round ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°
      const byRound = {};
      for (const m of s) {
        const r = m.round || 1;
        if (!byRound[r]) byRound[r] = [];
        byRound[r].push(m);
      }

      let html = "";
      const rounds = Object.keys(byRound).map(Number).sort((a,b)=>a-b);

      for (const r of rounds) {
        html += `<h3 style="margin-top:16px;">ğŸ Round ${r}</h3>`;
        html += `
          <table style="margin-bottom:12px;">
            <thead>
              <tr>
                <th>è©¦åˆ</th>
                <th>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§ä»£æ‰“ï¼‰</th>
                <th>ã‚¹ã‚³ã‚¢(A-B)</th>
                <th>ä¿å­˜</th>
              </tr>
            </thead>
            <tbody>
        `;

        for (const m of byRound[r]) {
          const a = (m.score && m.score.a) ? m.score.a : "";
          const b = (m.score && m.score.b) ? m.score.b : "";

          const playersHtml = (m.players||[])
            .map(p =>
              `<span class="player"
                data-name="${esc(p)}"
                style="cursor:pointer;text-decoration:underline;">${esc(p)}</span>`
            )
            .join(" / ");

          html += `
            <tr data-mk="${m.match_key}">
              <td>${esc(m.match_key)}</td>
              <td style="text-align:left">${playersHtml}</td>
              <td>
                <input type="text" class="sa" value="${esc(a)}" style="width:50px"> -
                <input type="text" class="sb" value="${esc(b)}" style="width:50px">
              </td>
              <td><button class="btn save-score">ä¿å­˜</button></td>
            </tr>
          `;
        }

        html += "</tbody></table>";
      }

      root.innerHTML = html;

      // ===== ä»£æ‰“ï¼ˆåå‰å·®ã—æ›¿ãˆï¼‰=====
      root.querySelectorAll(".player").forEach(sp => {
        sp.addEventListener("click", async () => {
          const oldName = sp.dataset.name;
          const newName = prompt(
            `ä»£æ‰“ã«å¤‰æ›´\nç¾åœ¨ï¼š${oldName}\næ–°ã—ã„åå‰ï¼ˆã‚¯ãƒ©ãƒ–ãƒ¡ãƒ³ãƒãƒ¼ã®è¡¨ç¤ºåï¼‰`,
            oldName
          );
          if (!newName || !newName.trim() || newName.trim() === oldName) return;

          try {
            const r = await postForm(`/api/event/${EVENT_ID}/schedule/swap_player/`, {
              old_name: oldName,
              new_name: newName.trim(),
            });
            if (!r.ok) throw new Error(r.error || "failed");
            renderSchedule(r.schedule);
          } catch (err) {
            alert(err.message);
          }
        });
      });

      // ===== ã‚¹ã‚³ã‚¢ä¿å­˜ =====
      root.querySelectorAll(".save-score").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          const tr = e.target.closest("tr");
          const mk = tr.dataset.mk;
          const sa = tr.querySelector(".sa").value;
          const sb = tr.querySelector(".sb").value;
          try {
            const r = await postForm(`/api/event/${EVENT_ID}/score/set/`, {
              match_key: mk, score_a: sa, score_b: sb
            });
            if (!r.ok) throw new Error(r.error || "failed");
            alert("ã‚¹ã‚³ã‚¢ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ­ãƒƒã‚¯ä¸­ãªã‚‰ãã®ã¾ã¾ä¿æŒã•ã‚Œã¾ã™ï¼‰");
            location.reload();
          } catch (err) {
            alert(err.message);
          }
        });
      });
    }





  // ãƒªã‚»ãƒƒãƒˆ
  document.getElementById("reset-btn").addEventListener("click", async () => {
    const ok = confirm("ãƒ­ãƒƒã‚¯ã¨ã‚¹ã‚³ã‚¢ã¨å¯¾æˆ¦è¡¨ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
    if (!ok) return;
    try {
      const r = await postForm(`/api/event/${EVENT_ID}/schedule/reset/`, {});
      if (!r.ok) throw new Error(r.error || "failed");
      location.reload();
    } catch (err) {
      alert(err.message);
    }
  });
</script>

</body>
</html>

<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>ã‚¯ãƒ©ãƒ–è¨­å®š - {{ club.name }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: sans-serif; margin: 16px; }
    .row { display: flex; gap: 24px; align-items: flex-start; flex-wrap: wrap; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 14px; min-width: 320px; }
    h1 { margin: 0 0 10px; font-size: 20px; }
    h2 { margin: 0 0 10px; font-size: 16px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    .muted { color: #666; font-size: 12px; }
    .btn { padding: 6px 10px; border: 1px solid #ccc; border-radius: 8px; background: #f7f7f7; cursor: pointer; }
    .btn:active { transform: translateY(1px); }
    .event { background: #e9f6ff; }
    .link { text-decoration: none; }
    input[type="text"] { padding: 6px 8px; width: 240px; }
    .list { display: grid; gap: 6px; }
    .item { display: flex; gap: 8px; align-items: center; justify-content: space-between; border: 1px solid #eee; border-radius: 8px; padding: 8px; }
  </style>
</head>
<body>

<h1>âš™ ã‚¯ãƒ©ãƒ–è¨­å®šï¼ˆå¹¹äº‹ï¼‰ - {{ club.name }}</h1>
<div class="muted">
  public: {{ club.public_token }} / admin: {{ club.admin_token }}
</div>

<div class="row">

  <div class="card">
    <h2>ğŸ“… å½“æœˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§ Event ä½œæˆ / ç§»å‹•ï¼‰</h2>
    <div class="muted">{{ year }}-{{ month|stringformat:"02d" }}</div>
    <table>
      <thead>
        <tr>
          <th>æ—¥ä»˜</th>
          <th>Event</th>
        </tr>
      </thead>
      <tbody id="calendar-body">
        {% for row in calendar_rows %}
          <tr data-date="{{ row.date }}" class="{% if row.event_id %}event{% endif %}">
            <td>{{ row.day }}</td>
            <td>
              {% if row.event_id %}
                <a class="link" href="/c/{{ club.public_token }}/e/{{ row.event_id }}/">é–‹ã (id={{ row.event_id }})</a>
              {% else %}
                <button class="btn create-event-btn" type="button">ä½œæˆ</button>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>

    </table>
    <div class="muted">â€» 1æ—¥1å›å›ºå®šï¼ˆclub+dateã§ãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰</div>
  </div>

  <div class="card">
    <h2>ğŸ‘¥ ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ </h2>
    <div style="display:flex; gap:8px; align-items:center;">
      <input id="member-name" type="text" placeholder="è¡¨ç¤ºåï¼ˆé‡è¤‡OKï¼‰" />
      <button id="member-add-btn" class="btn" type="button">è¿½åŠ </button>
    </div>
    <div class="muted">ãƒ¡ãƒ³ãƒãƒ¼ã¯å†…éƒ¨IDã§ç®¡ç†</div>

    <h2 style="margin-top:14px;">ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§</h2>
    <div id="members" class="list">
      {% for m in members %}
        <div class="item"><span>#{{ m.id }} {{ m.display_name }}</span></div>
      {% empty %}
        <div class="muted">ã¾ã ãƒ¡ãƒ³ãƒãƒ¼ãŒã„ã¾ã›ã‚“</div>
      {% endfor %}
    </div>
  </div>

  <div class="card">
    <h2>ğŸ· ãƒ•ãƒ©ã‚°ç®¡ç†ï¼ˆå…±é€šï¼‰</h2>

    <div style="display:flex; gap:8px; align-items:center;">
      <input id="flag-name" type="text" placeholder="æ–°ã—ã„ãƒ•ãƒ©ã‚°å" />
      <button id="flag-add-btn" class="btn" type="button">è¿½åŠ </button>
    </div>

    <h2 style="margin-top:14px;">ãƒ•ãƒ©ã‚°ä¸€è¦§</h2>
    <div id="flags" class="list">
      {% for f in flags %}
        <div class="item" data-flag-id="{{ f.id }}">
          <div>
            <div><b>({{ f.order }})</b> <span class="flag-name">{{ f.name }}</span></div>
            <div class="muted">active={{ f.is_active }}</div>
          </div>
          <div style="display:flex; gap:6px;">
            <button class="btn flag-rename-btn" type="button">åç§°å¤‰æ›´</button>
            <button class="btn flag-toggle-btn" type="button">{% if f.is_active %}éè¡¨ç¤º{% else %}å¾©æ´»{% endif %}</button>
          </div>
        </div>
      {% empty %}
        <div class="muted">ã¾ã ãƒ•ãƒ©ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</div>
      {% endfor %}
    </div>

    <div class="muted">â€» éè¡¨ç¤ºã§ã‚‚éå»ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒ</div>
  </div>

</div>

<script>
  const CLUB_PUBLIC = "{{ club.public_token }}";

  async function postForm(url, data) {
    const fd = new URLSearchParams();
    for (const [k, v] of Object.entries(data)) fd.append(k, v);
    const res = await fetch(url, { method: "POST", body: fd });
    const ct = res.headers.get("content-type") || "";
    if (ct.includes("application/json")) return await res.json();
    const txt = await res.text();
    throw new Error(`HTTP ${res.status}: ${txt}`);
  }

  // Event ä½œæˆ
  document.querySelectorAll(".create-event-btn").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      const tr = e.target.closest("tr");
      const d = tr.dataset.date;
      try {
        const r = await postForm(`/api/club/${CLUB_PUBLIC}/events/create/`, { date: d });
        if (!r.ok) throw new Error(r.error || "failed");
        location.reload(); // æœ€çŸ­ï¼šå†èª­ã¿è¾¼ã¿
      } catch (err) {
        alert(err.message);
      }
    });
  });

  // ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ 
  document.getElementById("member-add-btn").addEventListener("click", async () => {
    const name = document.getElementById("member-name").value.trim();
    if (!name) return alert("è¡¨ç¤ºåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    try {
      const r = await postForm(`/api/club/${CLUB_PUBLIC}/members/add/`, { display_name: name });
      if (!r.ok) throw new Error(r.error || "failed");
      location.reload();
    } catch (err) {
      alert(err.message);
    }
  });

  // ãƒ•ãƒ©ã‚°è¿½åŠ 
  document.getElementById("flag-add-btn").addEventListener("click", async () => {
    const name = document.getElementById("flag-name").value.trim();
    if (!name) return alert("ãƒ•ãƒ©ã‚°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    try {
      const r = await postForm(`/api/club/${CLUB_PUBLIC}/flags/add/`, { name });
      if (!r.ok) throw new Error(r.error || "failed");
      location.reload();
    } catch (err) {
      alert(err.message);
    }
  });

  // ãƒ•ãƒ©ã‚°åç§°å¤‰æ›´ / activeåˆ‡æ›¿
  document.querySelectorAll("#flags .item").forEach(item => {
    const flagId = item.dataset.flagId;

    item.querySelector(".flag-rename-btn")?.addEventListener("click", async () => {
      const current = item.querySelector(".flag-name")?.textContent || "";
      const name = prompt("æ–°ã—ã„åç§°", current);
      if (!name) return;
      try {
        const r = await postForm(`/api/club/${CLUB_PUBLIC}/flags/${flagId}/rename/`, { name });
        if (!r.ok) throw new Error(r.error || "failed");
        location.reload();
      } catch (err) {
        alert(err.message);
      }
    });

    item.querySelector(".flag-toggle-btn")?.addEventListener("click", async () => {
      try {
        const r = await postForm(`/api/club/${CLUB_PUBLIC}/flags/${flagId}/toggle_active/`, {});
        if (!r.ok) throw new Error(r.error || "failed");
        location.reload();
      } catch (err) {
        alert(err.message);
      }
    });
  });
</script>

</body>
</html>

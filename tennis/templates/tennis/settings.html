{# tennis/templates/tennis/settings.html #}
{% extends "tennis/base.html" %}
{% load static %}

{% block title %}クラブ設定 - 幹事用{% endblock %}

{% block extra_head %}
<script src="{% static 'tennis/club_settings.js' %}" defer></script>
{% endblock %}

{% block content %}

<div id="page-hooks"
     data-page="settings"
     data-club-token="{{ club.public_token }}"
     data-is-admin="{% if is_admin %}1{% else %}0{% endif %}">
</div>

<h2>クラブ設定画面</h2>

<hr>
<h3>クラブ名編集</h3>

{% if club %}
  <div class="theme-box" style="margin:12px 0; padding:10px;">

    {# ★クラブ名（クリックでモーダル） #}
    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
      <strong>クラブ名：</strong>

      <span id="club-name-display"
            style="cursor:pointer; text-decoration:underline; font-weight:700;"
            title="クリックして変更">
        {{ club.name }}
      </span>

      <small style="color:#666;">※クラブ名をクリックすると変更できます</small>
    </div>

    {# JS 用フック（API情報） #}
    <div id="club-rename-hooks"
        data-club-id="{{ club.id }}"
        data-admin-token="{{ club.admin_token }}"
        data-rename-url="{% url 'tennis:club_rename_club' %}"
        data-current-name="{{ club.name|escape }}">
    </div>

  </div>
{% endif %}

<hr>
<h3>メンバー管理</h3>

<div id="member-hooks"
     data-club-id="{{ club.id }}"
     data-admin-token="{{ club.admin_token }}"
     data-add-url="{% url 'tennis:club_add_member' %}"
     data-rename-url="{% url 'tennis:club_rename_member' %}"
     data-toggle-fixed-url="{% url 'tennis:club_toggle_member_fixed' %}">
</div>

<div class="members-admin-area">

  <table class="participants-table" id="members-table">
    <colgroup>
      <col style="width:50px;">
      <col style="width:160px;">
      <col style="width:100px;">
    </colgroup>
    <thead>
      <tr>
        <th>ID</th>
        <th>名前（クリックで変更）</th>
        <th>固定メンバー</th>
      </tr>
    </thead>
    <tbody>
      {% for m in members %}
        <tr data-member-id="{{ m.id }}" data-member-no="{{ m.member_no }}">
          <td>{{ m.member_no }}</td>
          <td>
            <span class="member-name"
                  style="cursor:pointer; text-decoration:underline; font-weight:700;"
                  title="クリックして変更">
              {{ m.display_name }}
            </span>
          </td>
          <td>
            <button type="button"
                    class="check-btn toggle-check member-fixed-toggle {% if m.is_fixed %}is-on{% endif %}"
                    data-kind="fixed">
              <span class="check-icon {% if m.is_fixed %}check-on{% else %}check-off{% endif %}">✓</span>
            </button>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

</div>

{% if not members %}
  <div class="participant-empty">名前がまだ登録されていません。</div>
{% endif %}

<hr>

<h3>出席表フォーマット設定</h3>

<div class="flag-add-area">
  <button type="button"
          id="club-add-flag-btn"
          class="flag-add-btn"
          data-club-id="{{ club.id }}"
          data-admin-token="{{ club.admin_token }}"
          data-add-flag-url="{% url 'tennis:club_add_flag' %}"
          {% if flags|length >= max_flags %}disabled{% endif %}>
      フラグ追加
  </button>

  <button type="button"
          id="club-delete-flag-btn"
          class="flag-delete-btn"
          data-club-id="{{ club.id }}"
          data-admin-token="{{ club.admin_token }}"
          data-delete-flag-url="{% url 'tennis:club_delete_flag' %}"
          {% if flags|length == 0 %}disabled{% endif %}>
      フラグ削除
  </button>

  <br>
  <small class="flag-note">
      任意のフラグを３つまで追加できます。（フラグ名をクリックすると編集できます）
  </small>
</div>

<div class="participants-wrap">

  <table id="participants-table"
        class="participants-table"
        data-mode="club_settings_dummy"
        data-club-id="{{ club.id }}"
        data-admin-token="{{ club.admin_token }}"
        data-rename-flag-url="{% url 'tennis:club_rename_flag' %}">

    <colgroup>
      <col style="width: 40px;">     {# 連番 #}
      <col style="width: 150px;">    {# 名前 #}
      <col style="width: 70px;">     {# 出欠 #}
      <col>                          {# 試合参加 #}
      {% for flag in flags %}
        <col>                        {# フラグ #}
      {% endfor %}
      <col style="width: 150px;">    {# コメント（名前と同じ固定幅） #}
    </colgroup>

    <thead>
      <tr>
        <th></th>
        <th>名前</th>
        <th>出欠</th>
        <th>試合参加</th>
        {% for flag in flags %}
          <th class="flag-header" data-flag-id="{{ flag.id }}">
            <span class="flag-name">{{ flag.name }}</span>
          </th>
        {% endfor %}
        <th>コメント</th>
      </tr>
    </thead>

    <tbody>
      {% for i in "1234" %}
      <tr>
        <td class="participant-index">{{ forloop.counter }}</td>

        <td><div class="tb-player-card-sm">&nbsp;</div></td>

        {# ★ 出欠：クリックでモーダル（〇×？） #}
        <td class="attendance-cell">
          <button type="button" class="attendance-btn" data-attendance="yes" aria-label="出欠">
            <span class="attendance-icon attendance-yes">✓</span>
          </button>
        </td>

        {# ★ 試合参加：ダミー操作OK／デフォルトON #}
        <td class="check-cell">
          <button type="button" class="check-btn toggle-check" data-default="on">
            <span class="check-icon check-on">✓</span>
          </button>
        </td>

        {# ★ フラグ：ダミー操作OK #}
        {% for flag in flags %}
          <td class="check-cell">
            {% if club.flag_input_mode|default:"check" == "digit" %}
              <input type="text"
                    inputmode="numeric"
                    pattern="[0-9]"
                    maxlength="1"
                    class="tb-score-input flag-digit-input"
                    data-input-mode="digit"
                    value="">
            {% else %}
              <button type="button" class="check-btn toggle-check">
                <span class="check-icon check-off">✓</span>
              </button>
            {% endif %}
          </td>
        {% endfor %}

        {# ★ コメント：枠なしのインライン編集（ダミー入力） #}
        <td class="comment-cell">
          <div class="comment-editable" contenteditable="true"></div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% endblock %}

{# tennis/templates/tennis/event.html #}
{% extends "tennis/base.html" %}
{% load static %}
{% load tennis_extras %}

{% block title %}{{ event.title }}{% if is_admin %} - å¹¹äº‹ç”¨{% endif %}{% endblock %}

{% block extra_head %}
  {# base.html ãŒå…±é€šCSS/å…±é€šJSã‚’èª­ã‚€ã€‚eventå›ºæœ‰ã¯ã“ã‚Œã ã‘ #}
  <script src="{% static 'tennis/event.js' %}" defer></script>
{% endblock %}

{% block content %}

<div id="page-hooks"
     data-page="event"
     data-club-token="{{ club.public_token }}"
     data-is-admin="{% if is_admin %}1{% else %}0{% endif %}">
</div>

{# â˜…ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿ï¼šç”»é¢å…¨ä½“ãƒˆãƒ¼ãƒ³ãƒ€ã‚¦ãƒ³ï¼ˆCSS: .event-page.is-cancelledï¼‰ #}
<div class="event-page {% if event.cancelled %}is-cancelled{% endif %}">

  <div class="event-head">
    <h2 class="event-title">{{ event.title }}</h2>

    <div id="event-meta-bar"
        class="event-meta-bar{% if is_admin %} is-admin is-clickable{% else %} is-public{% endif %}{% if event.cancelled %} is-cancelled{% endif %}"
        data-date="{{ event.date|date:'Y-m-d' }}"
        data-title="{{ event.title|default:'' }}"
        data-place="{{ event.place|default:'' }}"
        data-start="{{ event.start_time|time:'H:i'|default_if_none:'' }}"
        data-end="{{ event.end_time|time:'H:i'|default_if_none:'' }}"
        data-cancelled="{% if event.cancelled %}1{% else %}0{% endif %}"
        {% if is_admin %}title="ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç·¨é›†"{% endif %}>

      <span class="event-meta-text" id="event-meta-text">
        {{ event.date|date:"Y-m-d" }}
        {% if event.start_time and event.end_time %}
          {{ event.start_time|time:"H:i" }}ã€œ{{ event.end_time|time:"H:i" }}
        {% elif event.start_time %}
          {{ event.start_time|time:"H:i" }}ã€œ
        {% elif event.end_time %}
          ã€œ{{ event.end_time|time:"H:i" }}
        {% endif %}
        {% if event.place %} @ {{ event.place }}{% endif %}
      </span>
    </div>

    {% if event.cancelled %}
      <div class="event-cancel-badge">ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ä¸­æ­¢ã§ã™</div>
    {% endif %}
  </div>

  {# admin-only: event meta edit ã«å¿…è¦ãª hookï¼ˆevent.js ãŒå‚ç…§ï¼‰ #}
  {% if is_admin %}
    <div id="event-edit-hooks"
        data-event-id="{{ event.id }}"
        data-club-id="{{ club.id }}"
        data-public-token="{{ club.public_token }}"
        data-admin-token="{{ club.admin_token }}"
        data-update-url="{% url 'tennis:ajax_update_event' %}">
    </div>
  {% endif %}

  <hr>

  <div class="section-head">
    <h3 class="section-title">å‡ºå¸­è€…ãƒªã‚¹ãƒˆ</h3>
    <button type="button" class="btn btn-pill" id="add-guest-btn">
      å‚åŠ ç™»éŒ²
    </button>
  </div>

  <div class="participants-wrap">

    <table
      id="participants-table"
      data-is-admin="{% if is_admin %}1{% else %}0{% endif %}"
      data-event-id="{{ event.id }}"
      {% if is_admin %}data-admin-token="{{ club.admin_token }}"{% endif %}
      data-publish-state="{{ publish_state }}"
      data-update-attendance-url="{% url 'tennis:update_attendance' %}"
      data-update-comment-url="{% url 'tennis:update_comment' %}"
      data-toggle-flag-url="{% url 'tennis:toggle_participant_flag' %}"
      data-flag-input-mode="{{ flag_input_mode }}"
      data-set-flag-value-url="{% url 'tennis:set_participant_flag_value' %}"
      data-set-participates-match-url="{% url 'tennis:set_participates_match' %}"
      data-add-guest-url="{% url 'tennis:add_guest_participant' %}"
      data-publish-url="{% url 'tennis:publish_schedule' %}"
      data-save-score-url="{% url 'tennis:save_match_score' %}"
      data-substitute-url="{% url 'tennis:substitute_slot' %}"
    >
      <colgroup>
        <col style="width: 40px;">
        <col style="width: 130px;">
        <col style="width: 50px;">   {# å‡ºæ¬  #}
        <col style="width: 80px;">   {# è©¦åˆå‚åŠ  #}
        {% for flag in flags %}<col>{% endfor %}
        <col style="width: 180px;">
      </colgroup>

      <thead>
        <tr>
          <th></th>
          <th>åå‰</th>
          <th>å‡ºæ¬ </th>
          <th>è©¦åˆå‚åŠ </th>
          {% for flag in flags %}
            <th class="flag-header" data-flag-id="{{ flag.id }}">
              <span class="flag-name">{{ flag.name }}</span>
            </th>
          {% endfor %}
          <th>ã‚³ãƒ¡ãƒ³ãƒˆ</th>
        </tr>
      </thead>

      <tbody>
        {# ============= å›ºå®šãƒ¡ãƒ³ãƒãƒ¼ï¼ˆæœªç™»éŒ²è¡Œ=ep_idç©ºã®å¯èƒ½æ€§ã‚ã‚Šï¼‰ ============= #}
        {% for row in fixed_rows %}
        <tr class="participant-row"
            data-row-kind="fixed"
            data-member-id="{{ row.member_id }}"
            data-ep-id="{{ row.ep_id|default_if_none:'' }}">
          <td class="participant-index"><span class="idx">{{ forloop.counter }}</span></td>

          <td><div class="tb-player-card-sm">{{ row.display_name }}</div></td>

          {# â˜…å‡ºæ¬ ï¼ˆå¹¹äº‹/ä¸€èˆ¬ã©ã¡ã‚‰ã‚‚æ“ä½œå¯ï¼šattendance-btn ã¯å¸¸ã«å‡ºã™ï¼‰ #}
          <td class="attendance-cell">
            <button type="button"
                    class="attendance-btn"
                    data-member-id="{{ row.member_id }}"
                    data-ep-id="{{ row.ep_id|default_if_none:'' }}"
                    data-attendance="{{ row.attendance|default_if_none:'' }}">
              {% if row.attendance == "yes" %}
                <span class="attendance-icon attendance-yes">âœ“</span>
              {% elif row.attendance == "no" %}
                <span class="attendance-icon attendance-no">Ã—</span>
              {% elif row.attendance == "maybe" %}
                <span class="attendance-icon attendance-maybe">?</span>
              {% else %}
                <span class="attendance-icon attendance-maybe">?</span>
              {% endif %}
            </button>
          </td>

          {# â˜…è©¦åˆå‚åŠ ï¼ˆä¸¡æ–¹æ“ä½œå¯ï¼‰ï¼‹é€£å‹•ã®ãŸã‚è­˜åˆ¥classä»˜ä¸ï¼ˆattendance!=yes ã¯åˆæœŸéè¡¨ç¤ºï¼‰ #}
          <td class="check-cell match-cell">
            <button type="button"
                    class="check-btn toggle-check match-toggle
                          {% if row.participates_match %}is-on{% endif %}
                          {% if row.attendance != 'yes' %}is-hidden{% endif %}"
                    data-kind="match"
                    data-member-id="{{ row.member_id }}"
                    data-ep-id="{{ row.ep_id|default_if_none:'' }}">
              <span class="check-icon {% if row.participates_match %}check-on{% else %}check-off{% endif %}">âœ“</span>
            </button>
          </td>

          {# ===== flags ===== #}
          {% for flag in flags %}
            <td class="check-cell">
              {% if flag.input_mode == "digit" %}
                {# âœ… digitï¼šflag_states_val ã‚’å‚ç…§ #}
                {% with ep_flags=flag_states_val|get_item:row.ep_id %}
                  {% with val=ep_flags|get_item:flag.id %}
                    <input type="text"
                          inputmode="numeric"
                          pattern="[0-9]"
                          maxlength="1"
                          class="tb-score-input flag-digit-input"
                          data-input-mode="digit"
                          value="{% if val != None %}{{ val }}{% endif %}"
                          data-member-id="{{ row.member_id }}"
                          data-ep-id="{{ row.ep_id|default_if_none:'' }}"
                          data-flag-id="{{ flag.id }}">
                  {% endwith %}
                {% endwith %}
              {% else %}
                {# âœ… checkï¼šflag_states_on ã‚’å‚ç…§ #}
                {% with ep_flags=flag_states_on|get_item:row.ep_id %}
                  {% with on=ep_flags|get_item:flag.id %}
                    <button type="button"
                            class="check-btn toggle-check {% if on %}is-on{% endif %}"
                            data-member-id="{{ row.member_id }}"
                            data-ep-id="{{ row.ep_id|default_if_none:'' }}"
                            data-flag-id="{{ flag.id }}">
                      <span class="check-icon {% if on %}check-on{% else %}check-off{% endif %}">âœ“</span>
                    </button>
                  {% endwith %}
                {% endwith %}
              {% endif %}
            </td>
          {% endfor %}

          <td class="comment-cell">
            <div class="comment-editable"
                contenteditable="true"
                data-member-id="{{ row.member_id }}"
                data-ep-id="{{ row.ep_id|default_if_none:'' }}">{{ row.comment|default:'' }}</div>
          </td>
        </tr>
        {% endfor %}

        {# ============= ã‚²ã‚¹ãƒˆï¼ˆè‡¨æ™‚å‚åŠ ï¼šè¿½åŠ ã•ã‚ŒãŸã‚‰ã“ã®è¡¨ã«è¡¨ç¤ºã•ã‚Œã‚‹ï¼‰ ============= #}
        {% for row in guest_rows %}
        <tr class="participant-row"
            data-row-kind="guest"
            data-member-id="{{ row.member_id|default_if_none:'' }}"
            data-ep-id="{{ row.ep_id }}">
          <td class="participant-index">
            <span class="idx">{{ fixed_rows|length|add:forloop.counter }}</span>
          </td>

          <td><div class="tb-player-card-sm">{{ row.display_name }}</div></td>

          {# â˜…å‡ºæ¬ ï¼ˆå¸¸ã«æ“ä½œå¯ï¼‰ #}
          <td class="attendance-cell">
            <button type="button"
                    class="attendance-btn"
                    data-member-id="{{ row.member_id|default_if_none:'' }}"
                    data-ep-id="{{ row.ep_id }}"
                    data-attendance="{{ row.attendance|default_if_none:'' }}">
              {% if row.attendance == "yes" %}
                <span class="attendance-icon attendance-yes">âœ“</span>
              {% elif row.attendance == "no" %}
                <span class="attendance-icon attendance-no">Ã—</span>
              {% elif row.attendance == "maybe" %}
                <span class="attendance-icon attendance-maybe">?</span>
              {% else %}
                <span class="attendance-icon attendance-maybe">?</span>
              {% endif %}
            </button>
          </td>

          {# â˜…è©¦åˆå‚åŠ ï¼ˆå¸¸ã«æ“ä½œå¯ï¼‰ï¼‹é€£å‹•ã®ãŸã‚è­˜åˆ¥classä»˜ä¸ï¼ˆattendance!=yes ã¯åˆæœŸéè¡¨ç¤ºï¼‰ #}
          <td class="check-cell match-cell">
            <button type="button"
                    class="check-btn toggle-check match-toggle
                          {% if row.participates_match %}is-on{% endif %}
                          {% if row.attendance != 'yes' %}is-hidden{% endif %}"
                    data-kind="match"
                    data-member-id="{{ row.member_id|default_if_none:'' }}"
                    data-ep-id="{{ row.ep_id }}">
              <span class="check-icon {% if row.participates_match %}check-on{% else %}check-off{% endif %}">âœ“</span>
            </button>
          </td>

          {# ===== flags ===== #}
          {% for flag in flags %}
            <td class="check-cell">
              {% if flag.input_mode == "digit" %}
                {# âœ… digitï¼šflag_states_val ã‚’å‚ç…§ #}
                {% with ep_flags=flag_states_val|get_item:row.ep_id %}
                  {% with val=ep_flags|get_item:flag.id %}
                    <input type="text"
                          inputmode="numeric"
                          pattern="[0-9]"
                          maxlength="1"
                          class="tb-score-input flag-digit-input"
                          data-input-mode="digit"
                          value="{% if val != None %}{{ val }}{% endif %}"
                          data-member-id="{{ row.member_id|default_if_none:'' }}"
                          data-ep-id="{{ row.ep_id }}"
                          data-flag-id="{{ flag.id }}">
                  {% endwith %}
                {% endwith %}
              {% else %}
                {# âœ… checkï¼šflag_states_on ã‚’å‚ç…§ï¼ˆã“ã“ãŒä¸€ç•ªé–“é•ãˆã‚„ã™ã„ï¼‰ #}
                {% with ep_flags=flag_states_on|get_item:row.ep_id %}
                  {% with on=ep_flags|get_item:flag.id %}
                    <button type="button"
                            class="check-btn toggle-check {% if on %}is-on{% endif %}"
                            data-member-id="{{ row.member_id|default_if_none:'' }}"
                            data-ep-id="{{ row.ep_id }}"
                            data-flag-id="{{ flag.id }}">
                      <span class="check-icon {% if on %}check-on{% else %}check-off{% endif %}">âœ“</span>
                    </button>
                  {% endwith %}
                {% endwith %}
              {% endif %}
            </td>
          {% endfor %}

          <td class="comment-cell">
            <div class="comment-editable"
                contenteditable="true"
                data-member-id="{{ row.member_id|default_if_none:'' }}"
                data-ep-id="{{ row.ep_id }}">{{ row.comment|default:'' }}</div>
          </td>
        </tr>
        {% endfor %}

      </tbody>

    </table>

  </div>

  {{ sub_candidates|json_script:"sub-candidates-json" }}

  {# â˜…å›ºå®šã‚‚ã‚²ã‚¹ãƒˆã‚‚0ä»¶ãªã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º #}
  {% if not fixed_rows and not guest_rows %}
    <div class="participant-empty">åå‰ãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>
  {% endif %}

  <hr>

  {% if is_admin %}
  <h3>å¯¾æˆ¦è¡¨ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆï¼‰</h3>

  <div class="match-settings-bar">
    <div class="match-pill-group">
      <button type="button"
              id="pill-game-type"
              class="settings-pill game-type-pill settings-trigger {% if game_type == 'singles' %}pill-singles{% else %}pill-doubles{% endif %}">
        {% if game_type == "singles" %}ã‚·ãƒ³ã‚°ãƒ«ã‚¹{% else %}ãƒ€ãƒ–ãƒ«ã‚¹{% endif %}
      </button>

      <button type="button" id="pill-num-courts" class="settings-pill settings-trigger">
        {{ num_courts }} é¢
      </button>

      <button type="button" id="pill-match-count" class="settings-pill settings-trigger">
        {{ match_count }} äºº
      </button>

      <button type="button" id="pill-num-rounds" class="settings-pill settings-trigger">
        {{ num_rounds }} ãƒ©ã‚¦ãƒ³ãƒ‰
      </button>
    </div>

    <button type="button"
            id="publish-pill"
            class="settings-pill publish-pill {% if publish_state == 'no_schedule' or publish_state == 'published' %}pill-disabled{% endif %}"
            data-publish-state="{{ publish_state }}"
            onclick="publishSchedule()"
            {% if publish_state == 'no_schedule' or publish_state == 'published' %}disabled{% endif %}>
      {% if publish_state == 'published' %}
        å…¬é–‹æ¸ˆã¿
      {% elif publish_state == 'changed' %}
        å†å…¬é–‹
      {% else %}
        ğŸ“¢ å¯¾æˆ¦è¡¨ã‚’å…¬é–‹
      {% endif %}
    </button>
  </div>
  {% endif %}

  <h3>å¯¾æˆ¦è¡¨</h3>
  <div id="schedule-area"
      data-can-edit-score="{% if publish_state == 'published' %}1{% else %}0{% endif %}">
    {% include "tennis/_schedule_block.html" %}
  </div>

  {% if is_admin %}
    <div id="stats-area">
      {% include "tennis/_stats_block.html" %}
    </div>
  {% endif %}

</div>
{% endblock %}
